!function(){function t(t){for(var e in t)return!0;return!1}!function(){var t={exports:{}},e=t.exports;e.name="text",e.uri="http://sharejs.org/types/textv1",e.create=function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""};var i=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},n=function(t){if(!i(t))throw Error("Op must be an array of components");for(var e=null,n=0;t.length>n;n++){var o=t[n];switch(typeof o){case"object":if(!("number"==typeof o.d&&o.d>0))throw Error("Object components must be deletes of size > 0");break;case"string":if(!(o.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(o>0))throw Error("Skip components must be >0");if("number"==typeof e)throw Error("Adjacent skip components should be combined")}e=o}if("number"==typeof e)throw Error("Op has a trailing skip")},o=function(t){return function(e){return e&&0!==e.d?0===t.length?t.push(e):typeof e==typeof t[t.length-1]?"object"==typeof e?t[t.length-1].d+=e.d:t[t.length-1]+=e:t.push(e):void 0}},r=function(t){var e=0,i=0,n=function(n,o){if(e===t.length)return-1===n?null:n;var r,s=t[e];return"number"==typeof s?-1===n||n>=s-i?(r=s-i,++e,i=0,r):(i+=n,n):"string"==typeof s?-1===n||"i"===o||n>=s.length-i?(r=s.slice(i),++e,i=0,r):(r=s.slice(i,i+n),i+=n,r):-1===n||"d"===o||n>=s.d-i?(r={d:s.d-i},++e,i=0,r):(i+=n,{d:n})},o=function(){return t[e]};return[n,o]},s=function(t){return"number"==typeof t?t:t.length||t.d},a=function(t){return t.length>0&&"number"==typeof t[t.length-1]&&t.pop(),t};e.normalize=function(t){for(var e=[],i=o(e),n=0;t.length>n;n++)i(t[n]);return a(e)},e.apply=function(t,e){if("string"!=typeof t)throw Error("Snapshot should be a string");n(e);for(var i=[],o=0;e.length>o;o++){var r=e[o];switch(typeof r){case"number":if(r>t.length)throw Error("The op is too long for this document");i.push(t.slice(0,r)),t=t.slice(r);break;case"string":i.push(r);break;case"object":t=t.slice(r.d)}}return i.join("")+t},e.transform=function(t,e,i){if("left"!=i&&"right"!=i)throw Error("side ("+i+") must be 'left' or 'right'");n(t),n(e);for(var h=[],p=o(h),c=r(t),l=c[0],u=c[1],d=0;e.length>d;d++){var f,v,g=e[d];switch(typeof g){case"number":for(f=g;f>0;)v=l(f,"i"),p(v),"string"!=typeof v&&(f-=s(v));break;case"string":"left"===i&&"string"==typeof u()&&p(l(-1)),p(g.length);break;case"object":for(f=g.d;f>0;)switch(v=l(f,"i"),typeof v){case"number":f-=v;break;case"string":p(v);break;case"object":f-=v.d}}}for(;g=l(-1);)p(g);return a(h)},e.compose=function(t,e){n(t),n(e);for(var i=[],h=o(i),p=r(t)[0],c=0;e.length>c;c++){var l,u,d=e[c];switch(typeof d){case"number":for(l=d;l>0;)u=p(l,"d"),h(u),"object"!=typeof u&&(l-=s(u));break;case"string":h(d);break;case"object":for(l=d.d;l>0;)switch(u=p(l,"d"),typeof u){case"number":h({d:u}),l-=u;break;case"string":l-=u.length;break;case"object":h(u)}}}for(;d=p(-1);)h(d);return a(i)};var h=function(t,e){for(var i=0,n=0;e.length>n;n++){var o=e[n];if(i>=t)break;switch(typeof o){case"number":if(i+o>=t)return t;i+=o;break;case"string":i+=o.length,t+=o.length;break;case"object":t-=Math.min(o.d,t-i)}}return t};e.transformCursor=function(t,e,i){var n=0;if(i){for(var o=0;e.length>o;o++){var r=e[o];switch(typeof r){case"number":n+=r;break;case"string":n+=r.length}}return[n,n]}return[h(t[0],e),h(t[1],e)]};var p=window.ottypes=window.ottypes||{},c=t.exports;p[c.name]=c,c.uri&&(p[c.uri]=c)}();var e="undefined"!=typeof require?require("ottypes"):window.ottypes;e["http://sharejs.org/types/textv1"].api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},getText:function(){return this.getSnapshot()},insert:function(t,e,i){return this.submitOp([t,e],i)},remove:function(t,e,i){return this.submitOp([t,{d:e}],i)},_onOp:function(t){for(var e=0,i=0,n=0;n<t.length;n++){var o=t[n];switch(typeof o){case"number":e+=o,i+=o;break;case"string":this.onInsert&&this.onInsert(e,o),e+=o.length;break;case"object":this.onRemove&&this.onRemove(e,o.d),i+=o.d}}}},function(){var t={exports:{}},e=t.exports;e._bootstrapTransform=function(t,e,i,n){var o,r;return o=function(t,i,n,o){return e(n,t,i,"left"),e(o,i,t,"right")},t.transformX=t.transformX=r=function(t,e){var s,a,h,p,c,l,u,d,f,v,g,y,b,m,_,w,k,x,D;for(i(t),i(e),c=[],v=0,m=e.length;m>v;v++){for(f=e[v],p=[],s=0;t.length>s;){if(l=[],o(t[s],f,p,l),s++,1!==l.length){if(0===l.length){for(x=t.slice(s),g=0,_=x.length;_>g;g++)a=x[g],n(p,a);f=null;break}for(D=r(t.slice(s),l),h=D[0],d=D[1],y=0,w=h.length;w>y;y++)a=h[y],n(p,a);for(b=0,k=d.length;k>b;b++)u=d[b],n(c,u);f=null;break}f=l[0]}null!=f&&n(c,f),t=p}return[t,c]},t.transform=t.transform=function(t,i,n){if("left"!==n&&"right"!==n)throw Error("type must be 'left' or 'right'");return 0===i.length?t:1===t.length&&1===i.length?e([],t[0],i[0],n):"left"===n?r(t,i)[0]:r(i,t)[1]}};var i,n,o,r,s,a,h,p;a={name:"text-old",uri:"http://sharejs.org/types/textv0",create:function(){return""}},s=function(t,e,i){return t.slice(0,e)+i+t.slice(e)},n=function(t){var e,i;if("number"!=typeof t.p)throw Error("component missing position field");if(i=typeof t.i,e=typeof t.d,!("string"===i^"string"===e))throw Error("component needs an i or d field");if(!(t.p>=0))throw Error("position cannot be negative")},o=function(t){var e,i,o;for(i=0,o=t.length;o>i;i++)e=t[i],n(e);return!0},a.apply=function(t,e){var i,n,r,a;for(o(e),r=0,a=e.length;a>r;r++)if(i=e[r],null!=i.i)t=s(t,i.p,i.i);else{if(n=t.slice(i.p,i.p+i.d.length),i.d!==n)throw Error("Delete component '"+i.d+"' does not match deleted text '"+n+"'");t=t.slice(0,i.p)+t.slice(i.p+i.d.length)}return t},a._append=i=function(t,e){var i,n,o;return""!==e.i&&""!==e.d?0===t.length?t.push(e):(i=t[t.length-1],null!=i.i&&null!=e.i&&i.p<=(n=e.p)&&i.p+i.i.length>=n?t[t.length-1]={i:s(i.i,e.p-i.p,e.i),p:i.p}:null!=i.d&&null!=e.d&&e.p<=(o=i.p)&&e.p+e.d.length>=o?t[t.length-1]={d:s(e.d,i.p-e.p,i.d),p:e.p}:t.push(e)):void 0},a.compose=function(t,e){var n,r,s,a;for(o(t),o(e),r=t.slice(),s=0,a=e.length;a>s;s++)n=e[s],i(r,n);return r},a.compress=function(t){return a.compose([],t)},a.normalize=function(t){var e,n,o,r,s;for(n=[],(null!=t.i||null!=t.p)&&(t=[t]),o=0,r=t.length;r>o;o++)e=t[o],null==(s=e.p)&&(e.p=0),i(n,e);return n},p=function(t,e,i){return null!=e.i?t>e.p||e.p===t&&i?t+e.i.length:t:e.p>=t?t:e.p+e.d.length>=t?e.p:t-e.d.length},a.transformCursor=function(t,e,i){var n,o,r,s;for(o="right"===i,r=0,s=e.length;s>r;r++)n=e[r],t=p(t,n,o);return t},a._tc=h=function(t,e,n,r){var s,a,h,c,l,u;if(o([e]),o([n]),null!=e.i)i(t,{i:e.i,p:p(e.p,n,"right"===r)});else if(null!=n.i)u=e.d,e.p<n.p&&(i(t,{d:u.slice(0,n.p-e.p),p:e.p}),u=u.slice(n.p-e.p)),""!==u&&i(t,{d:u,p:e.p+n.i.length});else if(e.p>=n.p+n.d.length)i(t,{d:e.d,p:e.p-n.d.length});else if(e.p+e.d.length<=n.p)i(t,e);else{if(c={d:"",p:e.p},e.p<n.p&&(c.d=e.d.slice(0,n.p-e.p)),e.p+e.d.length>n.p+n.d.length&&(c.d+=e.d.slice(n.p+n.d.length-e.p)),h=Math.max(e.p,n.p),a=Math.min(e.p+e.d.length,n.p+n.d.length),s=e.d.slice(h-e.p,a-e.p),l=n.d.slice(h-n.p,a-n.p),s!==l)throw Error("Delete ops delete different text in the same region of the document");""!==c.d&&(c.p=p(c.p,n),i(t,c))}return t},r=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}},a.invert=function(t){var e,i,n,o,s;for(o=t.slice().reverse(),s=[],i=0,n=o.length;n>i;i++)e=o[i],s.push(r(e));return s},"undefined"==typeof require?e._bootstrapTransform(a,a.transformComponent,a.checkValidOp,a.append):require("./helpers")._bootstrapTransform(a,a.transformComponent,a.checkValidOp,a.append),t.exports=a;var c=function(t){return"[object Array]"==Object.prototype.toString.call(t)},l=function(t){return JSON.parse(JSON.stringify(t))},a="undefined"!=typeof require?require("./text-old"):window.ottypes.text,u={name:"json0",uri:"http://sharejs.org/types/JSONv0"};u.create=function(t){return void 0===t?null:t},u.invertComponent=function(t){var e={p:t.p};return void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},u.invert=function(t){for(var e=t.slice().reverse(),i=[],n=0;e.length>n;n++)i.push(u.invertComponent(e[n]));return i},u.checkValidOp=function(t){for(var e=0;t.length>e;e++)if(!c(t[e].p))throw Error("Missing path")},u.checkList=function(t){if(!c(t))throw Error("Referenced element not a list")},u.checkObj=function(t){if(t.constructor!==Object)throw Error("Referenced element not an object (it was "+JSON.stringify(t)+")")},u.apply=function(t,e){u.checkValidOp(e),e=l(e);for(var i={data:t},n=0;e.length>n;n++){for(var o=e[n],r=null,s=null,a=i,h="data",p=0;o.p.length>p;p++){var c=o.p[p];if(r=a,s=h,a=a[h],h=c,null==r)throw Error("Path invalid")}if(void 0!==o.na){if("number"!=typeof a[h])throw Error("Referenced element not a number");a[h]+=o.na}else if(void 0!==o.si){if("string"!=typeof a)throw Error("Referenced element not a string (it was "+JSON.stringify(a)+")");r[s]=a.slice(0,h)+o.si+a.slice(h)}else if(void 0!==o.sd){if("string"!=typeof a)throw Error("Referenced element not a string");if(a.slice(h,h+o.sd.length)!==o.sd)throw Error("Deleted string does not match");r[s]=a.slice(0,h)+a.slice(h+o.sd.length)}else if(void 0!==o.li&&void 0!==o.ld)u.checkList(a),a[h]=o.li;else if(void 0!==o.li)u.checkList(a),a.splice(h,0,o.li);else if(void 0!==o.ld)u.checkList(a),a.splice(h,1);else if(void 0!==o.lm){if(u.checkList(a),o.lm!=h){var d=a[h];a.splice(h,1),a.splice(o.lm,0,d)}}else if(void 0!==o.oi)u.checkObj(a),a[h]=o.oi;else{if(void 0===o.od)throw Error("invalid / missing instruction in op");u.checkObj(a),delete a[h]}}return i.data},u.incrementalApply=function(t,e,i){for(var n=0;e.length>n;n++){var o=[e[n]];t=u.apply(t,o),i(o,t)}return t};var d=u.pathMatches=function(t,e,i){if(t.length!=e.length)return!1;for(var n=0;t.length>n;n++)if(t[n]!==e[n]&&(!i||n!==t.length-1))return!1;return!0},f=function(t){var e={p:t.p[t.p.length-1]};return null!=t.si?e.i=t.si:e.d=t.sd,e};u.append=function(t,e){e=l(e);var i;if(0!=t.length&&d(e.p,(i=t[t.length-1]).p))null!=i.na&&null!=e.na?t[t.length-1]={p:i.p,na:i.na+e.na}:void 0!==i.li&&void 0===e.li&&e.ld===i.li?void 0!==i.ld?delete i.li:t.pop():void 0!==i.od&&void 0===i.oi&&void 0!==e.oi&&void 0===e.od?i.oi=e.oi:void 0!==i.oi&&void 0!==e.od?void 0!==e.oi?i.oi=e.oi:void 0!==i.od?delete i.oi:t.pop():void 0!==e.lm&&e.p[e.p.length-1]===e.lm||t.push(e);else if(0!=t.length&&d(e.p,i.p,!0))if(null==e.si&&null==e.sd||null==i.si&&null==i.sd)t.push(e);else{var n=[f(i)];if(a._append(n,f(e)),1!==n.length)t.push(e);else{var o=n[0];i.p[i.p.length-1]=o.p,null!=o.i?i.si=o.i:i.sd=o.d}}else t.push(e)},u.compose=function(t,e){u.checkValidOp(t),u.checkValidOp(e);for(var i=l(t),n=0;e.length>n;n++)u.append(i,e[n]);return i},u.normalize=function(t){var e=[];t=c(t)?t:[t];for(var i=0;t.length>i;i++){var n=t[i];null==n.p&&(n.p=[]),u.append(e,n)}return e},u.canOpAffectOp=function(t,e){if(0===t.length)return!0;if(0===e.length)return!1;e=e.slice(0,e.length-1),t=t.slice(0,t.length-1);for(var i=0;t.length>i;i++){var n=t[i];if(i>=e.length||n!=e[i])return!1}return!0},u.transformComponent=function(t,e,i,n){e=l(e),void 0!==e.na&&e.p.push(0),void 0!==i.na&&i.p.push(0);var o;u.canOpAffectOp(i.p,e.p)&&(o=i.p.length-1);var r;u.canOpAffectOp(e.p,i.p)&&(r=e.p.length-1);var s=e.p.length,h=i.p.length;if(void 0!==e.na&&e.p.pop(),void 0!==i.na&&i.p.pop(),i.na){if(null!=r&&h>=s&&i.p[r]==e.p[r])if(void 0!==e.ld){var p=l(i);p.p=p.p.slice(s),e.ld=u.apply(l(e.ld),[p])}else if(void 0!==e.od){var p=l(i);p.p=p.p.slice(s),e.od=u.apply(l(e.od),[p])}return u.append(t,e),t}if(null!=r&&h>s&&e.p[r]==i.p[r])if(void 0!==e.ld){var p=l(i);p.p=p.p.slice(s),e.ld=u.apply(l(e.ld),[p])}else if(void 0!==e.od){var p=l(i);p.p=p.p.slice(s),e.od=u.apply(l(e.od),[p])}if(null!=o){var c=s==h;if(void 0!==i.na);else if(void 0!==i.si||void 0!==i.sd){if(void 0!==e.si||void 0!==e.sd){if(!c)throw Error("must be a string?");var d=f(e),v=f(i),g=[];a._tc(g,d,v,n);for(var y=0;g.length>y;y++){var b=g[y],m={p:e.p.slice(0,o)};m.p.push(b.p),null!=b.i&&(m.si=b.i),null!=b.d&&(m.sd=b.d),u.append(t,m)}return t}}else if(void 0!==i.li&&void 0!==i.ld){if(i.p[o]===e.p[o]){if(!c)return t;if(void 0!==e.ld){if(void 0===e.li||"left"!==n)return t;e.ld=l(i.li)}}}else if(void 0!==i.li)void 0!==e.li&&void 0===e.ld&&c&&e.p[o]===i.p[o]?"right"===n&&e.p[o]++:i.p[o]<=e.p[o]&&e.p[o]++,void 0!==e.lm&&c&&i.p[o]<=e.lm&&e.lm++;else if(void 0!==i.ld){if(void 0!==e.lm&&c){if(i.p[o]===e.p[o])return t;var _=i.p[o],w=e.p[o],k=e.lm;(k>_||_===k&&k>w)&&e.lm--}if(i.p[o]<e.p[o])e.p[o]--;else if(i.p[o]===e.p[o]){if(s>h)return t;if(void 0!==e.ld){if(void 0===e.li)return t;delete e.ld}}}else if(void 0!==i.lm)if(void 0!==e.lm&&s===h){var w=e.p[o],k=e.lm,x=i.p[o],D=i.lm;if(x!==D)if(w===x){if("left"!==n)return t;e.p[o]=D,w===k&&(e.lm=D)}else w>x&&e.p[o]--,w>D?e.p[o]++:w===D&&x>D&&(e.p[o]++,w===k&&e.lm++),k>x?e.lm--:k===x&&k>w&&e.lm--,k>D?e.lm++:k===D&&(D>x&&k>w||x>D&&w>k?"right"===n&&e.lm++:k>w?e.lm++:k===x&&e.lm--)}else if(void 0!==e.li&&void 0===e.ld&&c){var w=i.p[o],k=i.lm;_=e.p[o],_>w&&e.p[o]--,_>k&&e.p[o]++}else{var w=i.p[o],k=i.lm;_=e.p[o],_===w?e.p[o]=k:(_>w&&e.p[o]--,_>k?e.p[o]++:_===k&&w>k&&e.p[o]++)}else if(void 0!==i.oi&&void 0!==i.od){if(e.p[o]===i.p[o]){if(void 0===e.oi||!c)return t;if("right"===n)return t;e.od=i.oi}}else if(void 0!==i.oi){if(void 0!==e.oi&&e.p[o]===i.p[o]){if("left"!==n)return t;u.append(t,{p:e.p,od:i.oi})}}else if(void 0!==i.od&&e.p[o]==i.p[o]){if(!c)return t;if(void 0===e.oi)return t;delete e.od}}return u.append(t,e),t},"undefined"!=typeof require?require("./helpers")._bootstrapTransform(u,u.transformComponent,u.checkValidOp,u.append):e._bootstrapTransform(u,u.transformComponent,u.checkValidOp,u.append),t.exports=u;var v=window.ottypes=window.ottypes||{},g=t.exports;v[g.name]=g,g.uri&&(v[g.uri]=g)}();var i=window.sharejs={version:"0.7.0"},n=function(){};n.prototype.on=function(t,e){var i=this._events=this._events||{};(i[t]=i[t]||[]).push(e)},n.prototype.removeListener=function(t,e){for(var i=this._events=this._events||{},n=i[t]=i[t]||[],o=0;o<n.length;)n[o]===e&&(n[o]=void 0),o++;setTimeout(function(){i[t]=[];for(var e,o=0;o<n.length;o++)(e=n[o])&&i[t].push(e)},0)},n.prototype.emit=function(t){var e=this._events,i=Array.prototype.splice.call(arguments,1);if(!e||!e[t])return"error"==t&&console&&console.error.apply(console,i),void 0;for(var n=e[t],o=0;o<n.length;o++)n[o]&&n[o].apply(this,i)},n.prototype.once=function(t,e){var i,n=this;this.on(t,i=function(){n.removeListener(t,i),e.apply(n,arguments)})},n.mixin=function(t){var e=t.prototype||t;return e.on=n.prototype.on,e.removeListener=n.prototype.removeListener,e.emit=n.prototype.emit,e.once=n.prototype.once,t},"undefined"!=typeof module&&(module.exports=n);var o,n;"undefined"!=typeof require?(o=require("ottypes"),n=require("./microevent")):o=window.ottypes;var r=i.Doc=function(t,e,i){this.connection=t,this.collection=e,this.name=i,this.version=this.type=null,this.action=null,this.state=null,this.subscribed=!1,this.wantSubscribe=!1,this._subscribeCallbacks=[],this.provides={},this.editingContexts=[],this.inflightData=null,this.pendingData=[]};n.mixin(r),r.prototype._setType=function(t){if("string"==typeof t){if(!o[t])throw Error("Missing type "+t);t=o[t]}this.removeContexts(),this.type=t,t?t.api&&(this.provides=t.api.provides):this.provides={}},r.prototype.injestData=function(t){if(this.state)return"undefined"!=typeof console&&console.warn("Ignoring attempt to injest data in state",this.state),void 0;if("number"!=typeof t.v)throw Error("Missing version in injested data");this.version=t.v,this.snapshot=t.snapshot,this._setType(t.type),this.state="ready",this.emit("ready")},r.prototype.getSnapshot=function(){return this.snapshot},r.prototype.whenReady=function(t){"ready"===this.state?t():this.on("ready",t)},r.prototype.hasPending=function(){return null!=this.inflightData||!!this.pendingData.length},r.prototype._send=function(t){t.c=this.collection,t.doc=this.name,this.connection.send(t)},r.prototype._onMessage=function(t){if(t.c!==this.collection||t.doc!==this.name)throw Error("Got message for wrong document.");switch(t.a){case"fetch":t.data&&this.injestData(t.data),this._finishSub("fetch",t.error),"fetch"===this.wantSubscribe&&(this.wantSubscribe=!1),this._clearAction("fetch");break;case"sub":t.error?(console&&console.error("Could not subscribe: "+t.error),this.emit("error",t.error),this._setWantSubscribe(!1,null,t.error)):(t.data&&this.injestData(t.data),this.subscribed=!0,this.emit("subscribe"),this._finishSub(!0)),this._clearAction("subscribe");break;case"unsub":this.subscribed=!1,this.emit("unsubscribe"),this._finishSub(!1,t.error),this._clearAction("unsubscribe");break;case"ack":t.error&&"Op already submitted"!==t.error&&(this._tryRollback(this.inflightData),this._clearInflightOp(t.error));break;case"op":if(this.inflightData&&t.src===this.inflightData.src&&t.seq===this.inflightData.seq){this._opAcknowledged(t);break}if(t.v!==this.version){this.emit("error","Expected version "+this.version+" but got "+t.v);break}this.inflightData&&p(this.inflightData,t);for(var e=0;e<this.pendingData.length;e++)p(this.pendingData[e],t);this.version++,this._otApply(t,!1),this._afterOtApply(t,!1);break;case"meta":console&&console.warn("Unhandled meta op:",t);break;default:console&&console.warn("Unhandled document message:",t)}},r.prototype._onConnectionStateChanged=function(t){"connecting"===t?this.inflightData?this._sendOpData():this.flush():"connected"===t?this.flush():"disconnected"===t&&(this.action=null,this.subscribed=!1,this.subscribed&&this.emit("unsubscribed"))},r.prototype._clearAction=function(t){this.action!==t&&console.warn("Unexpected action "+this.action+" expected: "+t),this.action=null,this.flush()},r.prototype.flush=function(){if(this.connection.canSend&&!this.action){for(var t;this.pendingData.length&&a(t=this.pendingData[0]);){for(var e=t.callbacks,i=0;i<e.length;i++)e[i](t.error);this.pendingData.shift()}this.subscribed&&!this.wantSubscribe?(this.action="unsubscribe",this._send({a:"unsub"})):this.subscribed||"fetch"!==this.wantSubscribe?!this.subscribed&&this.wantSubscribe?(this.action="subscribe",this._send("ready"===this.state?{a:"sub",v:this.version}:{a:"sub"})):!this.paused&&this.pendingData.length&&"connected"===this.connection.state&&(this.inflightData=this.pendingData.shift(),this._sendOpData()):(this.action="fetch",this._send("ready"===this.state?{a:"fetch",v:this.version}:{a:"fetch"}))}},r.prototype._setWantSubscribe=function(t,e,i){if(this.subscribed===this.wantSubscribe&&(this.subscribed===t||"fetch"===t&&this.subscribed))return e&&e(i),void 0;if(!this.wantSubscribe!=!t){for(var n=0;n<this._subscribeCallbacks.length;n++)this._subscribeCallbacks[n](i);this._subscribeCallbacks.length=0}("fetch"!==t||this.wantSubscribe!==!0)&&(this.wantSubscribe=t),e&&this._subscribeCallbacks.push(e),this.flush()},r.prototype.subscribe=function(t){this._setWantSubscribe(!0,t)},r.prototype.unsubscribe=function(t){this._setWantSubscribe(!1,t)},r.prototype.fetch=function(t){this._setWantSubscribe("fetch",t)},r.prototype._finishSub=function(t,e){if(t===this.wantSubscribe){for(var i=0;i<this._subscribeCallbacks.length;i++)this._subscribeCallbacks[i](e);this._subscribeCallbacks.length=0}};var s=function(t){delete t.op,delete t.create,delete t.del},a=function(t){return!t.op&&!t.create&&!t.del},h=function(t,e,i){if(e.create&&i.del)s(e);else if(e.create&&i.op){var n=void 0===e.create.data?t.create():e.create.data;e.create.data=t.apply(n,i.op)}else if(a(e))e.create=i.create,e.del=i.del,e.op=i.op;else{if(!(e.op&&i.op&&t.compose))return!1;e.op=t.compose(e.op,i.op)}return!0},p=function(t,e){if(e.create||e.del)return s(t);if(t.create)throw Error("Invalid state. This is a bug.");if(t.del)return s(e);if(e.op&&t.op)if(t.type.transformX){var i=t.type.transformX(t.op,e.op);t.op=i[0],e.op=i[1]}else{var n=t.type.transform(t.op,e.op,"left"),o=t.type.transform(e.op,t.op,"right");t.op=n,e.op=o}};r.prototype._otApply=function(t,e){if(this.locked=!0,t.create){var i=t.create;this._setType(i.type),this.snapshot=this.type.create(i.data),this.once("unlock",function(){this.emit("create",e)})}else if(t.del){var n=this.snapshot;this._setType(null),this.once("unlock",function(){this.emit("del",e,n)})}else if(t.op){if(!this.type)throw Error("Document does not exist");for(var o=this.type,r=t.op,s=0;s<this.editingContexts.length;s++){var a=this.editingContexts[s];a!=e&&a._beforeOp&&a._beforeOp(t.op)}if(this.emit("before op",r,e),this.incremental&&o.incrementalApply){var h=this;o.incrementalApply(this.snapshot,r,function(t,i){h.snapshot=i,h.emit("op",t,e)})}else this.snapshot=o.apply(this.snapshot,r),this.emit("op",r,e)}},r.prototype._afterOtApply=function(t,e){if(this.locked=!1,this.emit("unlock"),t.op){for(var i=this.editingContexts,n=0;n<i.length;n++){var o=i[n];o!=e&&o._onOp&&o._onOp(t.op)}for(var n=0;n<i.length;n++)i.remove&&i.splice(n--,1);return this.emit("after op",t.op,e)}},r.prototype._sendOpData=function(){var t=this.inflightData;if(this.action)throw Error("invalid state "+this.action+" for sendOpData");this.action="submit";var e={a:"op",v:this.version};t.src&&(e.src=t.src,e.seq=t.seq),t.op&&(e.op=t.op),t.create&&(e.create=t.create),t.del&&(e.del=t.del),e.c=this.collection,e.doc=this.name,this.connection.sendOp(e),t.src||(t.src=this.connection.id,t.seq=this.connection.seq++)},r.prototype._submitOpData=function(t,e,i){"function"==typeof e&&(i=e,e=!0),null==e&&(e=!0);var n=function(t){i?i(t):console&&console.warn("Failed attempt to submitOp:",t)};if(this.locked)return n("Cannot call submitOp from inside an 'op' event handler");if(t.op){if(!this.type)return n("Document has not been created");this.type.normalize&&(t.op=this.type.normalize(t.op))}this.state||(this.state="floating"),this._otApply(t,e);var o=this.pendingData[this.pendingData.length-1];this.pendingData.length&&(o=this.pendingData[this.pendingData.length-1],h(this.type,o,t))||(o=t,t.type=this.type,t.callbacks=[],this.pendingData.push(t)),i&&o.callbacks.push(i),this._afterOtApply(t,e);var r=this;setTimeout(function(){r.flush()},0)},r.prototype.submitOp=function(t,e,i){this._submitOpData({op:t},e,i)},r.prototype.create=function(t,e,i,n){return"function"==typeof e&&(i=e,e=void 0),this.type?(n&&n("Document already exists"),void 0):(this._submitOpData({create:{type:t,data:e}},i,n),void 0)},r.prototype.del=function(t,e){return this.type?(this._submitOpData({del:!0},t,e),void 0):(e&&e("Document does not exist"),void 0)},r.prototype.pause=function(){this.paused=!0},r.prototype.resume=function(){this.paused=!1,this.flush()},r.prototype._tryRollback=function(t){if(t.create)this._setType(null),"floating"===this.state?this.state=null:console.warn("Rollback a create from state "+this.state);else if(t.op&&t.type.invert){for(var e=t.type.invert(t.op),i=0;i<this.pendingData.length;i++)p(this.pendingData[i],e);this._otApply(e,!1),this._afterOtApply(e,!1)}else(t.op||t.del)&&(this._setType(null),this.version=null,this.state=null,this.subscribed=!1,this.emit("error","Op apply failed and the operation could not be reverted"),this.fetch(),this.flush())},r.prototype._clearInflightOp=function(t){for(var e=this.inflightData.callbacks,i=0;i<e.length;i++)e[i](t||this.inflightData.error);this.inflightData=null,this._clearAction("submit"),this.pendingData.length||this.emit("nothing pending")},r.prototype._opAcknowledged=function(t){if(!this.state)throw Error("opAcknowledged called from a null state. This should never happen.");if("floating"===this.state){if(!this.inflightData.create)throw Error("Cannot acknowledge an op.");this.version=t.v,this.state="ready";var e=this;setTimeout(function(){e.emit("ready")},0)}else if(t.v!==this.version)throw Error("Invalid version from server. Please file an issue, this is a bug.");this.version++,this._clearInflightOp()},r.prototype.createContext=function(){var t=this.type;if(!t)throw Error("Missing type");var e=this,i={getSnapshot:function(){return e.snapshot},submitOp:function(t,n){e.submitOp(t,i,n)},destroy:function(){this.detach&&(this.detach(),delete this.detach),delete this._onOp,this.remove=!0},_doc:this};if(t.api)for(var n in t.api)i[n]=t.api[n];else i.provides={};return this.editingContexts.push(i),i},r.prototype.removeContexts=function(){for(var t=0;t<this.editingContexts.length;t++)this.editingContexts[t].destroy();this.editingContexts.length=0};var o,r;"undefined"!=typeof require?(o=require("ottypes"),r=require("./doc").Doc,u=require("./query").Query):(o=window.ottypes,r=i.Doc);var c=i.Connection=function(t){this.socket=t,this.collections={},this.nextQueryId=1,this.queries={},this.state=0===t.readyState||1===t.readyState?"connecting":"disconnected",this.canSend="connecting"===this.state,this.reset();var e=this;t.onmessage=function(t){switch(t.a){case"init":if(0!==t.protocol)throw Error("Invalid protocol version");if("string"!=typeof t.id)throw Error("Invalid client id");e.id=t.id,e._setState("connected");break;case"qfetch":case"qsub":case"q":case"qunsub":var i=e.queries[t.id];i&&i._onMessage(t);break;default:var n,o,r;if(t.doc?(n=this._lastReceivedCollection=t.c,o=this._lastReceivedDoc=t.doc):(n=t.c=this._lastReceivedCollection,o=t.doc=this._lastReceivedDoc),r=e.get(n,o),!r){console&&console.error("Message for unknown doc. Ignoring.",t);break}r._onMessage(t)}},t.onopen=function(){e._setState("connecting")},t.onerror=function(t){e.emit("connection error",t)},t.onclose=function(t){e._setState("disconnected",t),("Closed"===t||"Stopped by server"===t)&&e._setState("stopped",t)}};c.prototype.reset=function(){this.id=this.lastError=this._lastReceivedCollection=this._lastReceivedDoc=this._lastSentCollection=this._lastSentDoc=null,this.seq=1},c.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state||"connected"===t&&"connecting"!==this.state)throw Error("Cannot transition directly from "+this.state+" to "+t);this.state=t,this.canSend="connecting"===t||"connected"===t,"disconnected"===t&&this.reset(),this.emit(t,e),this.opQueue=[];for(var i in this.collections){var n=this.collections[i];for(var o in n)n[o]._onConnectionStateChanged(t,e)}this.opQueue.sort(function(t,e){return t.seq-e.seq});for(var r=0;r<this.opQueue.length;r++)this.send(this.opQueue[r]);this.opQueue=null;for(var s in this.queries)this.queries[s]._onConnectionStateChanged(t,e)}},c.prototype.sendOp=function(t){this.opQueue?this.opQueue.push(t):this.send(t)},c.prototype.send=function(t){if(t.doc){var e=t.doc,i=t.c;i===this._lastSentCollection&&e===this._lastSentDoc?(delete t.c,delete t.doc):(this._lastSentCollection=i,this._lastSentDoc=e)}this.socket.send(t)},c.prototype.disconnect=function(){this.socket.close()},c.prototype.get=function(t,e){return this.collections[t]?this.collections[t][e]:void 0},c.prototype.getOrCreate=function(t,e,i){var n=this.get(t,e);if(n)return n;n=new r(this,t,e),i&&void 0!==i.snapshot&&n.injestData(i);var o=this.collections[t]=this.collections[t]||{};return o[e]=n},c.prototype.destroyDoc=function(e,i){var n=this.collections[e];n&&(delete n[i],t(n)||delete this.collections[e])},c.prototype._createQuery=function(t,e,i,n,o){if("fetch"!==t&&"sub"!==t)throw Error("Invalid query type: "+t);n||(n={});var r=this.nextQueryId++,s=new u(t,this,r,e,i,n,o);return this.queries[r]=s,s},c.prototype.createFetchQuery=function(t,e,i,n){return this._createQuery("fetch",t,e,i,n)},c.prototype.createSubscribeQuery=function(t,e,i,n){return this._createQuery("sub",t,e,i,n)},c.prototype.destroyQuery=function(t){delete this.queries[t.id]},"undefined"!=typeof require&&(n=require("./microevent")),n.mixin(c);var l=function(t,e,i){if(e!==i){for(var n=0;e.charAt(n)===i.charAt(n);)n++;for(var o=0;e.charAt(e.length-1-o)===i.charAt(i.length-1-o)&&o+n<e.length&&o+n<i.length;)o++;e.length!==n+o&&t.remove(n,e.length-n-o),i.length!==n+o&&t.insert(n,i.slice(n,i.length-o))}};window.sharejs.Doc.prototype.attachTextarea=function(t,e){if(e||(e=this.createContext()),!e.provides.text)throw Error("Cannot attach to non-text document");t.value=e.getText();var i,n=function(e,n){if(n)var o=[n(t.selectionStart),n(t.selectionEnd)];var r=t.scrollTop;t.value=e,i=t.value,t.scrollTop!==r&&(t.scrollTop=r),o&&window.document.activeElement===t&&(t.selectionStart=o[0],t.selectionEnd=o[1])};n(e.getText()),e.onInsert=function(e,i){var o=function(t){return t>e?t+i.length:t},r=t.value.replace(/\r\n/g,"\n");n(r.slice(0,e)+i+r.slice(e),o)},e.onRemove=function(e,i){var o=function(t){return t>e?t-Math.min(i,t-e):t},r=t.value.replace(/\r\n/g,"\n");n(r.slice(0,e)+r.slice(e+i),o)};for(var o=function(){setTimeout(function(){t.value!==i&&(i=t.value,l(e,e.getText(),t.value.replace(/\r\n/g,"\n")))},0)},r=["textInput","keydown","keyup","select","cut","paste"],s=0;s<r.length;s++){var a=r[s];t.addEventListener?t.addEventListener(a,o,!1):t.attachEvent("on"+a,o)}return e.detach=function(){for(var e=0;e<r.length;e++){var i=r[e];t.removeEventListener?t.removeEventListener(i,o,!1):t.detachEvent("on"+i,o)}},e};var r;"undefined"!=typeof require&&(r=require("./doc").Doc);var u=i.Query=function(t,e,i,n,o,r,s){this.type=t,this.connection=e,this.id=i,this.collection=n,this.query=o,this.autoFetch=r.autoFetch||!1,this.poll=r.poll,this.source=r.source,this.results=[],this.ready=!1,this.callback=s,this._sendSubFetch(this)};u.prototype.action="qsub",u.prototype._sendSubFetch=function(){if(this.connection.canSend){var t={a:"q"+this.type,id:this.id,c:this.collection,o:{f:this.autoFetch,b:this.source},q:this.query};void 0!==this.poll&&(t.o.p=this.poll),this.connection.send(t)}},u.prototype._dataToDocs=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];e.push(this.connection.getOrCreate(n.c||this.collection,n.docName,n))}return e},u.prototype.destroy=function(){this.connection.canSend&&"sub"===this.type&&this.connection.send({a:"qunsub",id:this.id}),this.connection.destroyQuery(this)},u.prototype._onConnectionStateChanged=function(){"connecting"===this.connection.state&&this._sendSubFetch()},u.prototype._onMessage=function(t){if("qfetch"===t.a!=("fetch"===this.type))return console&&console.warn("Invalid message sent to query",t,this),void 0;switch(t.error&&this.emit("error",t.error),t.a){case"qfetch":var e=t.data?this._dataToDocs(t.data):void 0;this.callback&&this.callback(t.error,e),this.connection.destroyQuery(this);break;case"q":if(t.diff)for(var i=0;i<t.diff.length;i++){var n=t.diff[i];switch(n.type){case"insert":var o=this._dataToDocs(n.values);this.results.splice(n.index,0,o),this.emit("insert",o,n.index);break;case"remove":var r=n.howMany||1,s=this.results.splice(n.index,r);this.emit("remove",s,n.index);break;case"move":var a=this.results.splice(n.from,r);this.results.splice(n.to,0,a),this.emit("move",a,n.from,n.to)}}break;case"qsub":if(!t.error){var h=this.results;this.results=this._dataToDocs(t.data),this.extra=t.extra,this.ready=!0,this.emit("change",this.results,h)}this.callback&&(this.callback(t.error,this.results),delete this.callback)}},u.prototype.setQuery=function(t){if("sub"!==this.type)throw Error("cannot change a fetch query");this.query=t,this.connection.canSend&&(this.connection.send({a:"qunsub",id:this.id}),this._sendSubFetch())};var n;"undefined"!=typeof require&&(n=require("./microevent")),n.mixin(u);var d,f,v,g,y,b,e,m=[].slice;e="undefined"==typeof window?require("ot-types"):window.ottypes,v=i.extendDoc,i.extendDoc=function(t,e){return d.prototype[t]=e,v(t,e)},f=function(t){return 1===t.length&&t[0].constructor===Array?t[0]:t},d=function(){function t(t,e){this.doc=t,this.path=e}return t.prototype.at=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],this.doc.at(this.path.concat(f(t)))},t.prototype.parent=function(){return this.path.length?this.doc.at(this.path.slice(0,this.path.length-1)):void 0},t.prototype.get=function(){return this.doc.getAt(this.path)},t.prototype.set=function(t,e){return this.doc.setAt(this.path,t,e)},t.prototype.insert=function(t,e,i){return this.doc.insertAt(this.path,t,e,i)
},t.prototype.del=function(t,e,i){return this.doc.deleteTextAt(this.path,e,t,i)},t.prototype.remove=function(t){return this.doc.removeAt(this.path,t)},t.prototype.push=function(t,e){return this.insert(this.get().length,t,e)},t.prototype.move=function(t,e,i){return this.doc.moveAt(this.path,t,e,i)},t.prototype.add=function(t,e){return this.doc.addAt(this.path,t,e)},t.prototype.on=function(t,e){return this.doc.addListener(this.path,t,e)},t.prototype.removeListener=function(t){return this.doc.removeListener(t)},t.prototype.getLength=function(){return this.get().length},t.prototype.getText=function(){return this.get()},t}(),y=function(t,e){var i,n,o,r,s,a;for(i={data:t},o="data",n=i,s=0,a=e.length;a>s;s++)if(r=e[s],n=n[o],o=r,void 0===n)throw Error("bad path");return{elem:n,key:o}},g=function(t,e){var i,n,o,r;if(t.length!==e.length)return!1;for(n=o=0,r=t.length;r>o;n=++o)if(i=t[n],i!==e[n])return!1;return!0},b=e["http://sharejs.org/types/JSONv0"],b.api={provides:{json:!0},_fixComponentPaths:function(t){var e,i,n,o,r,s,a,h,p,c,l;if(this._listeners&&void 0===t.na&&void 0===t.si&&void 0===t.sd){for(o=[],c=this._listeners,i=s=0,h=c.length;h>s;i=++s)if(n=c[i],e={p:n.path,na:0},r=b.transformComponent([],e,t,"left"),0===r.length)o.push(i);else{if(1!==r.length)throw Error("Bad assumption in json-api: xforming an 'na' op will always result in 0 or 1 components.");n.path=r[0].p}for(o.sort(function(t,e){return e-t}),l=[],a=0,p=o.length;p>a;a++)i=o[a],l.push(this._listeners.splice(i,1));return l}},_fixPaths:function(t){var e,i,n,o;for(o=[],i=0,n=t.length;n>i;i++)e=t[i],o.push(this._fixComponentPaths(e));return o},_submit:function(t,e){return this._fixPaths(t),this.submitOp(t,e)},at:function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],new d(this,f(t))},get:function(){return this.snapshot},set:function(t,e){return this.setAt([],t,e)},getAt:function(t){var e,i,n;return n=y(this.snapshot,t),e=n.elem,i=n.key,e[i]},setAt:function(t,e,i){var n,o,r,s;if(s=y(this.snapshot,t),n=s.elem,o=s.key,r={p:t},n.constructor===Array)r.li=e,void 0!==n[o]&&(r.ld=n[o]);else{if("object"!=typeof n)throw Error("bad path");r.oi=e,void 0!==n[o]&&(r.od=n[o])}return this._submit([r],i)},removeAt:function(t,e){var i,n,o,r;if(r=y(this.snapshot,t),i=r.elem,n=r.key,void 0===i[n])throw Error("no element at that path");if(o={p:t},i.constructor===Array)o.ld=i[n];else{if("object"!=typeof i)throw Error("bad path");o.od=i[n]}return this._submit([o],e)},insertAt:function(t,e,i,n){var o,r,s,a;return a=y(this.snapshot,t),o=a.elem,r=a.key,s={p:t.concat(e)},o[r].constructor===Array?s.li=i:"string"==typeof o[r]&&(s.si=i),this._submit([s],n)},moveAt:function(t,e,i,n){var o;return o=[{p:t.concat(e),lm:i}],this._submit(o,n)},addAt:function(t,e,i){var n;return n=[{p:t,na:e}],this._submit(n,i)},deleteTextAt:function(t,e,i,n){var o,r,s,a;return a=y(this.snapshot,t),o=a.elem,r=a.key,s=[{p:t.concat(i),sd:o[r].slice(i,i+e)}],this._submit(s,n)},addListener:function(t,e,i){var n;return this._listeners||(this._listeners=[]),n={path:t,event:e,cb:i},this._listeners.push(n),n},removeListener:function(t){var e;if(this._listeners)return e=this._listeners.indexOf(t),0>e?!1:(this._listeners.splice(e,1),!0)},_onOp:function(t){var e,i,n,o,r,s,a,h,p;for(p=[],a=0,h=t.length;h>a;a++)e=t[a],this._fixComponentPaths(e),r=void 0===e.na?e.p.slice(0,e.p.length-1):e.p,p.push(function(){var t,a,h,p,c;for(h=this._listeners,c=[],t=0,a=h.length;a>t;t++)if(p=h[t],s=p.path,o=p.event,i=p.cb,g(s,r))switch(o){case"insert":void 0!==e.li&&void 0===e.ld?c.push(i(e.p[e.p.length-1],e.li)):void 0!==e.oi&&void 0===e.od?c.push(i(e.p[e.p.length-1],e.oi)):void 0!==e.si?c.push(i(e.p[e.p.length-1],e.si)):c.push(void 0);break;case"delete":void 0===e.li&&void 0!==e.ld?c.push(i(e.p[e.p.length-1],e.ld)):void 0===e.oi&&void 0!==e.od?c.push(i(e.p[e.p.length-1],e.od)):void 0!==e.sd?c.push(i(e.p[e.p.length-1],e.sd)):c.push(void 0);break;case"replace":void 0!==e.li&&void 0!==e.ld?c.push(i(e.p[e.p.length-1],e.ld,e.li)):void 0!==e.oi&&void 0!==e.od?c.push(i(e.p[e.p.length-1],e.od,e.oi)):c.push(void 0);break;case"move":void 0!==e.lm?c.push(i(e.p[e.p.length-1],e.lm)):c.push(void 0);break;case"add":void 0!==e.na?c.push(i(e.na)):c.push(void 0);break;default:c.push(void 0)}else b.canOpAffectOp(s,r)?"child op"===o?(n=e.p.slice(s.length),c.push(i(n,e))):c.push(void 0):c.push(void 0);return c}.call(this));return p}}}();